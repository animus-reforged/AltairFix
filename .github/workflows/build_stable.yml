name: Build stable version and draft release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag for the release (e.g., 1.0.0)"
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0
          fetch-tags: true

      - name: Configure Git
        run: |
          git config --global user.email "78475878+shazzaam7@users.noreply.github.com"
          git config --global user.name "Shazzaam7"
          git fetch --tags --force

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build DLL
        run: msbuild AltairFix.sln /p:Configuration=Release /p:Platform=x86

      - name: Prepare Artifact Layout (scripts/)
        shell: pwsh
        run: |
          $artifactDir = "output/artifact_package/scripts"
          New-Item -ItemType Directory -Force -Path $artifactDir | Out-Null
          Copy-Item "output/Release/*.asi" $artifactDir/
          Copy-Item "output/Release/*.ini" $artifactDir/
          Compress-Archive -Path "output/artifact_package/*" `
                           -DestinationPath "output/Release/AltairFix-artifact.zip" -Force

      - name: Prepare Release Layout (flat)
        shell: pwsh
        run: |
          Compress-Archive -Path "output/Release/*.asi","output/Release/*.ini" `
                           -DestinationPath "output/Release/AltairFix.zip" -Force

      - name: Upload Artifact (scripts/ layout)
        uses: actions/upload-artifact@v4
        with:
          name: AltairFix-artifact
          path: output/Release/AltairFix-artifact.zip
          if-no-files-found: error

      - name: Generate Release Notes Body
        id: notes
        shell: pwsh
        run: .\.github\workflows\changelog_generator.ps1 -Tag "${{ github.event.inputs.tag }}" -Repository "${{ github.repository }}"

      - name: Create Draft Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          draft: true
          artifacts: output/Release/AltairFix.zip
          replacesArtifacts: true
          body: ${{ steps.notes.outputs.body }}a